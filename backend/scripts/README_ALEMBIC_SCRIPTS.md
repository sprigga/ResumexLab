# Alembic è‡ªå‹•åŒ–è…³æœ¬ä½¿ç”¨æŒ‡å—

**å°ˆæ¡ˆ**: ResumeXLab
**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2026-01-04
**ä½œè€…**: Polo (æ—é´»å…¨)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®éŒ„åŒ…å«ä¸‰å€‹ Alembic é·ç§»è‡ªå‹•åŒ–è…³æœ¬ï¼Œç”¨æ–¼ç°¡åŒ–è³‡æ–™åº«é·ç§»æ“ä½œä¸¦è™•ç†å¸¸è¦‹å•é¡Œã€‚

### è…³æœ¬åˆ—è¡¨

| è…³æœ¬åç¨± | é¡å‹ | åŠŸèƒ½æè¿° |
|---------|------|---------|
| `alembic_helper.py` | Python | å¤šåŠŸèƒ½åŠ©æ‰‹ï¼Œæä¾›ç‹€æ…‹æŸ¥è©¢ã€é·ç§»åŸ·è¡Œã€å•é¡Œä¿®å¾©ç­‰ |
| `alembic_create_migration.sh` | Bash | è‡ªå‹•åŒ–é·ç§»å‰µå»ºæµç¨‹ï¼ŒåŒ…å«å‚™ä»½å’Œå…¼å®¹æ€§æª¢æŸ¥ |
| `alembic_diagnose.sh` | Bash | å•é¡Œè¨ºæ–·å·¥å…·ï¼Œè‡ªå‹•æª¢æ¸¬å¸¸è¦‹é…ç½®å’Œç’°å¢ƒå•é¡Œ |

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. alembic_helper.py - ä¸»è¦åŠ©æ‰‹è…³æœ¬

**åŠŸèƒ½**ï¼šæä¾›å®Œæ•´çš„ Alembic æ“ä½œåŠŸèƒ½

#### å¯ç”¨æŒ‡ä»¤

```bash
# æŸ¥çœ‹ä½¿ç”¨èªªæ˜
python script/alembic_helper.py help

# æª¢æŸ¥ç•¶å‰ç‹€æ…‹
python script/alembic_helper.py status

# åŸ·è¡Œå¥åº·æª¢æŸ¥
python script/alembic_helper.py check

# å‚™ä»½è³‡æ–™åº«
python script/alembic_helper.py backup

# åŸ·è¡Œé·ç§»ï¼ˆæœƒè‡ªå‹•å‚™ä»½ï¼‰
python script/alembic_helper.py migrate

# æ¨™è¨˜è³‡æ–™åº«ç‰ˆæœ¬
python script/alembic_helper.py stamp

# ä¿®å¾© SQLite ALTER COLUMN å•é¡Œ
python script/alembic_helper.py fix-sqlite

# å›æ»¾åˆ°ä¸Šä¸€å€‹ç‰ˆæœ¬
python script/alembic_helper.py rollback
```

#### ä½¿ç”¨ç¯„ä¾‹

```bash
# å ´æ™¯ 1: é¦–æ¬¡è¨­å®šï¼Œè³‡æ–™åº«å·²æœ‰è¡¨ä½†æœªæ¨™è¨˜ç‰ˆæœ¬
python script/alembic_helper.py status
# ç™¼ç¾: "è³‡æ–™åº«å°šæœªæ¨™è¨˜ç‰ˆæœ¬"
python script/alembic_helper.py stamp
# çµæœ: è³‡æ–™åº«è¢«æ¨™è¨˜ç‚ºæœ€æ–°ç‰ˆæœ¬

# å ´æ™¯ 2: åŸ·è¡Œæ–°çš„é·ç§»
python script/alembic_helper.py migrate
# è‡ªå‹•å‚™ä»½è³‡æ–™åº«
# åŸ·è¡Œé·ç§»
# é¡¯ç¤ºçµæœ

# å ´æ™¯ 3: é·ç§»å¤±æ•—ï¼Œå‡ºç¾ ALTER COLUMN éŒ¯èª¤
python script/alembic_helper.py fix-sqlite
# è‡ªå‹•æƒææœ€æ–°é·ç§»æª”æ¡ˆ
# è¨»è§£æ‰ä¸æ”¯æ´çš„æ“ä½œ
# å‚™ä»½åŸæª”æ¡ˆ

# å ´æ™¯ 4: éœ€è¦å›æ»¾
python script/alembic_helper.py rollback
# è‡ªå‹•å‚™ä»½è³‡æ–™åº«
# å›æ»¾åˆ°ä¸Šä¸€ç‰ˆæœ¬
# é¡¯ç¤ºç•¶å‰ç‰ˆæœ¬
```

---

### 2. alembic_create_migration.sh - é·ç§»å‰µå»ºè…³æœ¬

**åŠŸèƒ½**ï¼šè‡ªå‹•åŒ–é·ç§»å‰µå»ºæµç¨‹

#### åŸºæœ¬ç”¨æ³•

```bash
# å‰µå»ºé·ç§»ï¼ˆä¸è‡ªå‹•æ‡‰ç”¨ï¼‰
./script/alembic_create_migration.sh "é·ç§»æè¿°"

# å‰µå»ºä¸¦è‡ªå‹•æ‡‰ç”¨é·ç§»
./script/alembic_create_migration.sh "é·ç§»æè¿°" --apply
```

#### åŸ·è¡Œæµç¨‹

æ­¤è…³æœ¬æœƒè‡ªå‹•åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š

1. **ç’°å¢ƒæª¢æŸ¥**
   - æª¢æŸ¥è™›æ“¬ç’°å¢ƒ
   - æª¢æŸ¥ Alembic é…ç½®
   - æª¢æŸ¥è³‡æ–™åº«å­˜åœ¨æ€§

2. **æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬**
   - é¡¯ç¤ºç•¶å‰è³‡æ–™åº«ç‰ˆæœ¬
   - è­¦å‘Šæœªæ¨™è¨˜ç‰ˆæœ¬çš„æƒ…æ³

3. **å‚™ä»½è³‡æ–™åº«**
   - è‡ªå‹•å‚™ä»½åˆ° `backend/data/resume_backup_[timestamp].db`
   - é¡¯ç¤ºå‚™ä»½å¤§å°

4. **ç”Ÿæˆé·ç§»æª”æ¡ˆ**
   - åŸ·è¡Œ `alembic revision --autogenerate`
   - é¡¯ç¤ºç”Ÿæˆçš„æª”æ¡ˆè·¯å¾‘

5. **SQLite å…¼å®¹æ€§æª¢æŸ¥**
   - è‡ªå‹•åµæ¸¬ `ALTER COLUMN` æ“ä½œ
   - æä¾›è‡ªå‹•ä¿®å¾©é¸é …
   - é¡¯ç¤ºä¿®å¾©å»ºè­°

6. **é¡¯ç¤ºè®Šæ›´æ‘˜è¦**
   - çµ±è¨ˆæ–°å¢/åˆªé™¤çš„è¡¨å’Œæ¬„ä½
   - è­¦å‘Šæ²’æœ‰åµæ¸¬åˆ°è®Šæ›´çš„æƒ…æ³

7. **æ‡‰ç”¨é·ç§»ï¼ˆå¯é¸ï¼‰**
   - ä½¿ç”¨ `--apply` åƒæ•¸æ™‚è‡ªå‹•åŸ·è¡Œ
   - é¡¯ç¤ºåŸ·è¡Œçµæœ

#### ä½¿ç”¨ç¯„ä¾‹

```bash
# ç¯„ä¾‹ 1: æ–°å¢æ¬„ä½
./script/alembic_create_migration.sh "æ–°å¢ä½¿ç”¨è€…é ­åƒæ¬„ä½"

# ç¯„ä¾‹ 2: æ–°å¢è¡¨ä¸¦è‡ªå‹•æ‡‰ç”¨
./script/alembic_create_migration.sh "æ–°å¢æŠ€èƒ½è¡¨" --apply

# ç¯„ä¾‹ 3: ä¿®æ”¹ç¾æœ‰çµæ§‹
./script/alembic_create_migration.sh "æ›´æ–°å·¥ä½œç¶“æ­·è¡¨çµæ§‹"
```

#### è¼¸å‡ºç¯„ä¾‹

```
================================================
  Alembic é·ç§»å‰µå»ºåŠ©æ‰‹
================================================

â„¹ é·ç§»æè¿°: æ–°å¢ä½¿ç”¨è€…é ­åƒæ¬„ä½

================================================
  æ­¥é©Ÿ 1: ç’°å¢ƒæª¢æŸ¥
================================================

âœ“ è™›æ“¬ç’°å¢ƒå­˜åœ¨
âœ“ Alembic é…ç½®å­˜åœ¨
âœ“ è³‡æ–™åº«å­˜åœ¨
â„¹ è³‡æ–™åº«å¤§å°: 120K

================================================
  æ­¥é©Ÿ 2: æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬
================================================

âœ“ ç•¶å‰ç‰ˆæœ¬: d711f173f9e3 (head)

================================================
  æ­¥é©Ÿ 3: å‚™ä»½è³‡æ–™åº«
================================================

âœ“ å‚™ä»½å®Œæˆ: data/resume_backup_20260104_173000.db
â„¹ å‚™ä»½å¤§å°: 120K

...
```

---

### 3. alembic_diagnose.sh - è¨ºæ–·è…³æœ¬

**åŠŸèƒ½**ï¼šå¿«é€Ÿè¨ºæ–· Alembic è¨­å®šå’Œå¸¸è¦‹å•é¡Œ

#### åŸºæœ¬ç”¨æ³•

```bash
./script/alembic_diagnose.sh
```

#### è¨ºæ–·é …ç›®

1. **è™›æ“¬ç’°å¢ƒæª¢æŸ¥**
   - æª¢æŸ¥ .venv å­˜åœ¨
   - æª¢æŸ¥ Alembic å®‰è£
   - é¡¯ç¤º Alembic ç‰ˆæœ¬

2. **Alembic é…ç½®æª¢æŸ¥**
   - æª¢æŸ¥ alembic.ini
   - æª¢æŸ¥è³‡æ–™åº« URL è¨­å®š
   - æª¢æŸ¥ env.py å’Œ target_metadata

3. **è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥**
   - æª¢æŸ¥è³‡æ–™åº«æª”æ¡ˆå­˜åœ¨
   - æª¢æŸ¥ alembic_version è¡¨
   - åˆ—å‡ºæ‰€æœ‰è³‡æ–™è¡¨

4. **é·ç§»ä¸€è‡´æ€§æª¢æŸ¥**
   - æ¯”å° Alembic HEAD å’Œç•¶å‰ç‰ˆæœ¬
   - æª¢æŸ¥æ˜¯å¦éœ€è¦å‡ç´š

5. **SQLite å…¼å®¹æ€§æª¢æŸ¥**
   - æƒææœ€æ–°é·ç§»æª”æ¡ˆ
   - åµæ¸¬ ALTER COLUMN æ“ä½œ

6. **å¸¸è¦‹éŒ¯èª¤è¨ºæ–·**
   - åŸ·è¡Œ `alembic check`
   - æª¢æŸ¥ Python cache

#### è¼¸å‡ºç¯„ä¾‹

```
================================================
  Alembic å•é¡Œè¨ºæ–·å·¥å…·
================================================

â„¹ å·¥ä½œç›®éŒ„: /path/to/backend

================================================
  æª¢æŸ¥ 1: è™›æ“¬ç’°å¢ƒ
================================================

âœ“ è™›æ“¬ç’°å¢ƒå­˜åœ¨
âœ“ Alembic å·²å®‰è£
â„¹ ç‰ˆæœ¬: alembic 1.12.0

================================================
  æª¢æŸ¥ 2: Alembic é…ç½®
================================================

âœ“ alembic.ini å­˜åœ¨
âœ“ è³‡æ–™åº« URL å·²è¨­å®š
â„¹ URL: sqlite:///./data/resume.db
âœ“ alembic ç›®éŒ„å­˜åœ¨
âœ“ env.py å­˜åœ¨
âœ“ target_metadata å·²è¨­å®š
âœ“ versions ç›®éŒ„å­˜åœ¨ (2 å€‹é·ç§»)

...

================================================
  è¨ºæ–·ç¸½çµ
================================================

âœ“ æœªç™¼ç¾å•é¡Œï¼ç³»çµ±ç‹€æ…‹è‰¯å¥½
```

---

## ğŸ“– å¸¸è¦‹ä½¿ç”¨å ´æ™¯

### å ´æ™¯ 1: é¦–æ¬¡è¨­å®š Alembic

```bash
# 1. æª¢æŸ¥ç’°å¢ƒ
./script/alembic_diagnose.sh

# 2. å¦‚æœè³‡æ–™åº«å·²æœ‰è¡¨ï¼Œæ¨™è¨˜ç‰ˆæœ¬
python script/alembic_helper.py stamp

# 3. é©—è­‰ç‹€æ…‹
python script/alembic_helper.py status
```

### å ´æ™¯ 2: æ–°å¢åŠŸèƒ½éœ€è¦ä¿®æ”¹è³‡æ–™åº«

```bash
# 1. ä¿®æ”¹ SQLAlchemy Model
# ç·¨è¼¯ backend/app/models/*.py

# 2. å‰µå»ºé·ç§»
./script/alembic_create_migration.sh "æ–°å¢åŠŸèƒ½XYZçš„è³‡æ–™è¡¨"

# 3. æª¢æŸ¥ç”Ÿæˆçš„é·ç§»æª”æ¡ˆ
# å¦‚æœ‰ SQLite å…¼å®¹æ€§å•é¡Œï¼Œè…³æœ¬æœƒæç¤ºä¸¦æä¾›ä¿®å¾©é¸é …

# 4. æ‡‰ç”¨é·ç§»
python script/alembic_helper.py migrate
```

### å ´æ™¯ 3: é·ç§»å¤±æ•—éœ€è¦ä¿®å¾©

```bash
# 1. è¨ºæ–·å•é¡Œ
./script/alembic_diagnose.sh

# 2. å¦‚æœæ˜¯ ALTER COLUMN å•é¡Œ
python script/alembic_helper.py fix-sqlite

# 3. é‡æ–°åŸ·è¡Œé·ç§»
python script/alembic_helper.py migrate
```

### å ´æ™¯ 4: éœ€è¦å›æ»¾è®Šæ›´

```bash
# 1. æŸ¥çœ‹ç•¶å‰ç‹€æ…‹
python script/alembic_helper.py status

# 2. å›æ»¾åˆ°ä¸Šä¸€ç‰ˆæœ¬
python script/alembic_helper.py rollback

# 3. é©—è­‰çµæœ
python script/alembic_helper.py status
```

### å ´æ™¯ 5: å®šæœŸç¶­è­·æª¢æŸ¥

```bash
# æ¯é€±åŸ·è¡Œä¸€æ¬¡å¥åº·æª¢æŸ¥
python script/alembic_helper.py check

# æˆ–ä½¿ç”¨è¨ºæ–·å·¥å…·
./script/alembic_diagnose.sh
```

---

## ğŸ”§ é€²éšä½¿ç”¨

### è‡ªå‹•ä¿®å¾© SQLite å…¼å®¹æ€§å•é¡Œ

`alembic_helper.py` çš„ `fix-sqlite` æŒ‡ä»¤æœƒï¼š

1. æƒææœ€æ–°çš„é·ç§»æª”æ¡ˆ
2. æ‰¾å‡ºæ‰€æœ‰ `op.alter_column` æ“ä½œ
3. è‡ªå‹•è¨»è§£é€™äº›ä¸æ”¯æ´çš„æ“ä½œ
4. å‚™ä»½åŸæª”æ¡ˆç‚º `.py.bak`
5. æ·»åŠ èªªæ˜è¨»è§£

**ç¯„ä¾‹**ï¼š

åŸå§‹é·ç§»æª”æ¡ˆï¼š
```python
def upgrade() -> None:
    op.alter_column('project_details', 'id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
    op.add_column('projects', sa.Column('attachment_name', sa.String(length=255)))
```

ä¿®å¾©å¾Œï¼š
```python
def upgrade() -> None:
    # åŸæœ¬çš„ ALTER COLUMN æ“ä½œ (å·²è¨»è§£æ–¼ 2026-01-04ï¼ŒåŸå› ï¼šSQLite ä¸æ”¯æ´ ALTER COLUMN)
    # op.alter_column('project_details', 'id',
    #            existing_type=sa.INTEGER(),
    #            nullable=False,
    #            autoincrement=True)
    op.add_column('projects', sa.Column('attachment_name', sa.String(length=255)))
```

### æ‰¹æ¬¡è™•ç†å¤šå€‹é·ç§»

```bash
#!/bin/bash
# æ‰¹æ¬¡å‰µå»ºå¤šå€‹é·ç§»

migrations=(
    "æ–°å¢ä½¿ç”¨è€…é ­åƒæ¬„ä½"
    "æ–°å¢æŠ€èƒ½è¡¨"
    "æ›´æ–°å·¥ä½œç¶“æ­·ç´¢å¼•"
)

for msg in "${migrations[@]}"; do
    echo "å‰µå»ºé·ç§»: $msg"
    ./script/alembic_create_migration.sh "$msg"
    sleep 2
done

echo "æ‰€æœ‰é·ç§»å·²å‰µå»ºï¼Œè«‹æª¢æŸ¥å¾ŒåŸ·è¡Œæ‡‰ç”¨"
```

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. å‚™ä»½é‡è¦æ€§

æ‰€æœ‰æ¶‰åŠè³‡æ–™åº«è®Šæ›´çš„è…³æœ¬éƒ½æœƒ**è‡ªå‹•å‚™ä»½**ï¼Œä½†å»ºè­°ï¼š

- å®šæœŸæ‰‹å‹•å‚™ä»½é‡è¦è³‡æ–™
- å‚™ä»½æª”æ¡ˆä½æ–¼ `backend/data/resume_backup_*.db`
- ç”Ÿç”¢ç’°å¢ƒæ“ä½œå‰**å‹™å¿…**é¡å¤–å‚™ä»½

### 2. SQLite é™åˆ¶

è…³æœ¬æœƒè‡ªå‹•è™•ç† SQLite é™åˆ¶ï¼Œä½†éœ€äº†è§£ï¼š

- âœ… **æ”¯æ´**: ADD COLUMN, DROP COLUMN (SQLite 3.35.0+), RENAME TABLE
- âŒ **ä¸æ”¯æ´**: ALTER COLUMN, DROP CONSTRAINT, éƒ¨åˆ† ADD CONSTRAINT

### 3. é·ç§»æª”æ¡ˆæª¢æŸ¥

å³ä½¿ä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬ï¼Œä»å»ºè­°ï¼š

- æª¢æŸ¥ç”Ÿæˆçš„é·ç§»æª”æ¡ˆå…§å®¹
- é©—è­‰ `upgrade()` å’Œ `downgrade()` é‚è¼¯
- ç¢ºèªè®Šæ›´ç¬¦åˆé æœŸ

### 4. ç’°å¢ƒéœ€æ±‚

è…³æœ¬éœ€è¦ï¼š

- Python 3.10+
- Bash shell (macOS/Linux)
- SQLite3 æŒ‡ä»¤ï¼ˆç”¨æ–¼è¨ºæ–·ï¼‰
- è™›æ“¬ç’°å¢ƒ (.venv)

---

## ğŸ› ç–‘é›£æ’è§£

### å•é¡Œ 1: è…³æœ¬ç„¡æ³•åŸ·è¡Œ

```bash
# ç¢ºèªåŸ·è¡Œæ¬Šé™
ls -l script/alembic_*.sh

# å¦‚æœæ²’æœ‰åŸ·è¡Œæ¬Šé™ï¼Œæ·»åŠ æ¬Šé™
chmod +x script/alembic_*.sh script/alembic_helper.py
```

### å•é¡Œ 2: "æ‰¾ä¸åˆ° alembic æŒ‡ä»¤"

```bash
# ç¢ºèªè™›æ“¬ç’°å¢ƒ
ls -la backend/.venv

# é‡æ–°å®‰è£ Alembic
cd backend
source .venv/bin/activate
pip install alembic
```

### å•é¡Œ 3: è¨ºæ–·è…³æœ¬é¡¯ç¤ºå¤šå€‹å•é¡Œ

```bash
# ä¾ç…§è¨ºæ–·è…³æœ¬çš„å»ºè­°é€ä¸€ä¿®å¾©
# ä¿®å¾©å¾Œå†æ¬¡åŸ·è¡Œè¨ºæ–·
./script/alembic_diagnose.sh
```

### å•é¡Œ 4: è‡ªå‹•ä¿®å¾©å¤±æ•—

```bash
# æª¢æŸ¥é·ç§»æª”æ¡ˆå‚™ä»½
ls -la backend/alembic/versions/*.bak

# æ‰‹å‹•æ¢å¾©
cd backend/alembic/versions
mv xxxx.py.bak xxxx.py

# æ‰‹å‹•ç·¨è¼¯é·ç§»æª”æ¡ˆ
```

---

## ğŸ“š åƒè€ƒè³‡æº

- **å°ˆæ¡ˆæ–‡ä»¶**: `/docs/Alembic.md`
- **Alembic å®˜æ–¹æ–‡ä»¶**: https://alembic.sqlalchemy.org/
- **SQLAlchemy æ–‡ä»¶**: https://www.sqlalchemy.org/

---

## ğŸ”„ æ›´æ–°æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è®Šæ›´èªªæ˜ |
|------|------|---------|
| 1.0 | 2026-01-04 | åˆç‰ˆï¼ŒåŒ…å«ä¸‰å€‹è‡ªå‹•åŒ–è…³æœ¬ |

---

## ğŸ‘¤ ä½œè€…èˆ‡ç¶­è­·

**ä½œè€…**: Polo (æ—é´»å…¨)
**Email**: sprigga@gmail.com
**å°ˆæ¡ˆ**: ResumeXLab

---

## ğŸ“„ æˆæ¬Š

é€™äº›è…³æœ¬æ˜¯ ResumeXLab å°ˆæ¡ˆçš„ä¸€éƒ¨åˆ†ï¼Œåƒ…ä¾›å°ˆæ¡ˆå…§éƒ¨ä½¿ç”¨ã€‚

---

**æœ€å¾Œæ›´æ–°**: 2026-01-04
